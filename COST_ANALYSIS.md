# Анализ стоимости запросов после добавления предобработки

## Структура запросов

### ДО изменений (на один поиск):
1. **Embedding API** (text-embedding-004) - 1 запрос
   - Создание вектора из запроса пользователя
   
2. **LLM для выбора** (gemini-2.5-flash-lite) - 1 запрос
   - Выбор лучшей песни из 5 кандидатов
   - Промпт: ~2000-3000 входных токенов (few-shot examples + кандидаты)
   - Ответ: ~200-300 выходных токенов (JSON с выбором и объяснением)

**Итого: 2 API запроса**

---

### ПОСЛЕ изменений (на один поиск):
1. **LLM для улучшения запроса** (gemini-2.5-flash-lite) - **1 НОВЫЙ запрос**
   - Предобработка запроса пользователя
   - Промпт: ~500-600 входных токенов (примеры + запрос пользователя)
   - Ответ: ~50-100 выходных токенов (улучшенный запрос)
   - maxOutputTokens: 200 (ограничение)

2. **Embedding API** (text-embedding-004) - 1 запрос
   - Создание вектора из улучшенного запроса
   - Стоимость та же

3. **LLM для выбора** (gemini-2.5-flash-lite) - 1 запрос
   - Выбор лучшей песни из 5 кандидатов
   - Промпт: ~2000-3000 входных токенов
   - Ответ: ~200-300 выходных токенов

**Итого: 3 API запроса (+50% к количеству запросов)**

---

## Оценка стоимости (примерная)

### Google Gemini API цены (примерные, на январь 2025):
- **Gemini 2.5 Flash Lite**: 
  - Входные токены: ~$0.075 за 1M токенов
  - Выходные токены: ~$0.30 за 1M токенов

- **Text Embedding 004**:
  - ~$0.0001 за 1K токенов (очень дешево)

### Расчет стоимости на один поиск:

#### ДО изменений:
1. Embedding: ~$0.0001 (запрос обычно <1K токенов)
2. LLM выбор: 
   - Входные: 2500 токенов × $0.075/1M = $0.0001875
   - Выходные: 250 токенов × $0.30/1M = $0.000075
   - **Итого LLM: ~$0.00026**

**Общая стоимость: ~$0.00036 за поиск**

#### ПОСЛЕ изменений:
1. LLM улучшение:
   - Входные: 550 токенов × $0.075/1M = $0.00004125
   - Выходные: 75 токенов × $0.30/1M = $0.0000225
   - **Итого: ~$0.000064** (НОВОЕ)

2. Embedding: ~$0.0001 (то же)

3. LLM выбор: ~$0.00026 (то же)

**Общая стоимость: ~$0.00042 за поиск**

---

## Увеличение стоимости

**Абсолютное увеличение:** +$0.00006 за поиск (+17%)

**Относительное увеличение:** +50% к количеству LLM запросов, но только +17% к общей стоимости

### Почему увеличение невелико?

1. **Используется самая дешевая модель** (gemini-2.5-flash-lite)
2. **Короткий промпт** для улучшения (~550 токенов vs ~2500 для выбора)
3. **Ограниченный ответ** (maxOutputTokens: 200)
4. **Embedding API очень дешевый** (не влияет на увеличение)

---

## Примеры для масштабирования

### 1000 поисков в месяц:
- **ДО:** ~$0.36
- **ПОСЛЕ:** ~$0.42
- **Доплата:** ~$0.06/месяц

### 10,000 поисков в месяц:
- **ДО:** ~$3.60
- **ПОСЛЕ:** ~$4.20
- **Доплата:** ~$0.60/месяц

### 100,000 поисков в месяц:
- **ДО:** ~$36
- **ПОСЛЕ:** ~$42
- **Доплата:** ~$6/месяц

---

## Оптимизации для снижения стоимости

1. **Кэширование улучшенных запросов** - можно добавить кэш для часто используемых запросов
2. **Отключение опции** - `enhance_query: false` в запросе
3. **Условная предобработка** - только для коротких/неформальных запросов
4. **Использование еще более легкой модели** - если доступна

---

## Вывод

Добавление предобработки запроса увеличивает стоимость на **~17%** (или **+$0.00006 за поиск**), что является разумной платой за улучшение качества поиска, особенно для неформальных запросов.

При этом:
- ✅ Используется самая дешевая модель
- Промпт короткий и оптимизирован
- Можно легко отключить через параметр `enhance_query: false`
- Улучшение качества поиска может быть значительным
